import { Component, OnInit } from '@angular/core';
import { DomSanitizer, SafeHtml } from '@angular/platform-browser';
import { CommonModule } from '@angular/common';
import { SearchService } from '../search.service';

@Component({
  selector: 'app-component-a',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './component-a.component.html',
  styleUrl: './component-a.component.css',
})
export class ComponentAComponent implements OnInit {
  befits = [
    {
      id: 36,
      heading: 'Sample',
      data: `<div><p>This is sample paragraph. Search here for test.</p></div>`,
      expanded: false,
    },
    {
      id: 37,
      heading: 'Test Accordion',
      data: `<div><p>Another paragraph with searchable content and more text.</p></div>`,
      expanded: false,
    },
  ];

  sanitizedHtml: SafeHtml[] = [];

  constructor(
    private searchService: SearchService,
    private sanitizer: DomSanitizer
  ) {}

  ngOnInit() {
    this.searchService.query$.subscribe((query) => {
      this.sanitizedHtml = [];
      const allMatches: HTMLElement[] = [];

      this.befits.forEach((item, index) => {
        const regex = new RegExp(`(${query})`, 'gi');
        item.expanded = false;
        if (query && (item.data + item.heading).match(regex)) {
          item.expanded = true;
        }

        const highlighted = item.data.replace(regex, `<mark class="highlight">$1</mark>`);
        this.sanitizedHtml[index] = this.sanitizer.bypassSecurityTrustHtml(highlighted);
      });

      setTimeout(() => {
        const matches = Array.from(document.querySelectorAll('.highlight')) as HTMLElement[];
        this.searchService.registerMatches(matches);
      });
    });
  }
}
