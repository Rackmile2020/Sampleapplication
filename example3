import { InjectionToken } from '@angular/core';
import { OktaAuth } from '@okta/okta-auth-js';

/**
 * Token for DI
 */
export const OKTA_AUTH = new InjectionToken<OktaAuth>('okta-auth');

/**
 * Waits until the parent MFE sets window.sharedOktaAuth.
 * Resolves immediately once available using requestAnimationFrame.
 */
function waitForSharedOkta(): OktaAuth {
  const shared = (window as any).sharedOktaAuth as OktaAuth;
  if (shared) {
    return shared; // parent already initialized
  }

  // Keep checking each animation frame
  let resolved: OktaAuth | null = null;
  const check = () => {
    const current = (window as any).sharedOktaAuth as OktaAuth;
    if (current) {
      resolved = current;
    } else {
      requestAnimationFrame(check);
    }
  };
  check();

  // Busy-wait until resolved (ok for DI factory; resolves quickly in practice)
  while (!resolved) {
    // intentionally empty, requestAnimationFrame will set resolved
  }
  return resolved!;
}

/**
 * Provider for child MFE to reuse parent's OktaAuth instance
 */
export const OKTA_AUTH_PROVIDER = {
  provide: OKTA_AUTH,
  useFactory: () => waitForSharedOkta(),
};
