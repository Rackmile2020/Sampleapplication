@Injectable({ providedIn: 'root' })
export class MycoverageRealignDialogService {
  private activeDialogs = new Map<
    string,
    { componentRef: ComponentRef<any>; subscription: Subscription; focusTrap?: FocusTrap }
  >();

  constructor(
    private injector: Injector,
    private appRef: ApplicationRef,
    private environmentInjector: EnvironmentInjector,
    private focusTrapFactory: FocusTrapFactory
  ) {}

  open<C = any, R = any, T extends DialogComponentBase<C, R> = DialogComponentBase<C, R>>(
    component: Type<T>,
    config: C,
    dialogId?: string
  ): DialogRef<C, R> {
    const id = dialogId || Symbol().toString();

    // Close if already open
    if (this.activeDialogs.has(id)) {
      this.close(id);
    }

    const componentRef = createComponent(component, {
      environmentInjector: this.environmentInjector,
      elementInjector: this.injector,
    });
    componentRef.instance.config = config;

    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    document.body.appendChild(backdrop);
    document.body.appendChild(componentRef.location.nativeElement);

    this.appRef.attachView(componentRef.hostView);

    // ðŸ”¹ Focus trap initialization
    const focusTrap = this.focusTrapFactory.create(componentRef.location.nativeElement);
    focusTrap.focusInitialElementWhenReady();

    // Add accessibility attributes
    const dialogEl = componentRef.location.nativeElement as HTMLElement;
    dialogEl.setAttribute('role', 'dialog');
    dialogEl.setAttribute('aria-modal', 'true');
    dialogEl.tabIndex = -1;

    // Focus the dialog
    dialogEl.focus();

    // Create dialogRef
    const dialogRef = new DialogRef<C, R>(id, componentRef, this.appRef);
    let subscription: Subscription | undefined;

    if (componentRef.instance.closeEvent) {
      subscription = componentRef.instance.closeEvent.subscribe((result?: R) => {
        dialogRef.close(result);
      });
    }

    this.activeDialogs.set(id, {
      componentRef,
      subscription: subscription || new Subscription(),
      focusTrap,
    });

    // Disable background scroll
    document.body.classList.add('modal-open');
    document.body.style.overflow = 'hidden';
    document.body.style.paddingRight = '0';

    return dialogRef;
  }

  close(dialogId: string): void {
    const dialog = this.activeDialogs.get(dialogId);
    if (dialog) {
      dialog.subscription.unsubscribe();
      dialog.focusTrap?.destroy();
      new DialogRef('temp', dialog.componentRef, this.appRef).close();
      this.activeDialogs.delete(dialogId);
    }
  }

  closeAll(): void {
    Array.from(this.activeDialogs.keys()).forEach(id => this.close(id));
  }
}
