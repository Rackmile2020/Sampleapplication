import { Injectable, Renderer2, RendererFactory2 } from '@angular/core';

@Injectable({ providedIn: 'root' })
export class FocusTrapService {
  private focusableElements: HTMLElement[] = [];
  private activeElementBeforeTrap: HTMLElement | null = null;
  private cleanupListener: (() => void) | null = null;
  private renderer: Renderer2;

  constructor(rendererFactory: RendererFactory2) {
    this.renderer = rendererFactory.createRenderer(null, null);
  }

  trapFocus(container: HTMLElement, onEscape?: () => void) {
    // Save previously focused element
    this.activeElementBeforeTrap = document.activeElement as HTMLElement;

    // Ensure dialog container is focusable
    if (!container.hasAttribute('tabindex')) {
      container.setAttribute('tabindex', '-1');
    }

    // Focus the dialog container
    container.focus();

    // Collect all focusable elements inside
    this.focusableElements = Array.from(
      container.querySelectorAll<HTMLElement>(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      )
    );

    // Listen for keyboard events
    this.cleanupListener = this.renderer.listen(container, 'keydown', (event: KeyboardEvent) => {
      if (event.key === 'Tab') this.handleTab(event);
      if (event.key === 'Escape' && onEscape) onEscape();
    });
  }

  private handleTab(event: KeyboardEvent) {
    const first = this.focusableElements[0];
    const last = this.focusableElements[this.focusableElements.length - 1];

    if (event.shiftKey) {
      // Shift + Tab
      if (document.activeElement === first) {
        event.preventDefault();
        last.focus();
      }
    } else {
      // Tab
      if (document.activeElement === last) {
        event.preventDefault();
        first.focus();
      }
    }
  }

  releaseFocus() {
    if (this.cleanupListener) {
      this.cleanupListener();
      this.cleanupListener = null;
    }

    // Restore focus
    if (this.activeElementBeforeTrap) {
      this.activeElementBeforeTrap.focus();
      this.activeElementBeforeTrap = null;
    }

    this.focusableElements = [];
  }
}
