import { Injectable } from '@angular/core';
import { Router, NavigationStart } from '@angular/router';
import { BehaviorSubject } from 'rxjs';
import { filter } from 'rxjs/operators';

@Injectable({ providedIn: 'root' })
export class BackDetectorService {
  private backNavSubject = new BehaviorSubject<boolean>(false);
  public backNav$ = this.backNavSubject.asObservable();
  private urlHistory: string[] = [];

  constructor(private router: Router) {
    this.router.events
      .pipe(filter(e => e instanceof NavigationStart))
      .subscribe((event: NavigationStart & { navigationTrigger?: string }) => {
        const trigger = event.navigationTrigger;
        const currentUrl = event.url;

        // Always push first URL if stack is empty
        if (!this.urlHistory.length) {
          this.urlHistory.push(currentUrl);
        }

        const lastIndex = this.urlHistory.lastIndexOf(currentUrl);

        // Detect back click:
        // 1. popstate triggered
        // 2. current URL exists in history (could be first back click)
        if (trigger === 'popstate' && lastIndex > 0) {
          this.backNavSubject.next(true);
          console.log('⬅️ Browser BACK detected:', currentUrl);

          // Remove all URLs ahead of current
          this.urlHistory = this.urlHistory.slice(0, lastIndex + 1);

          // Reset flag shortly after
          setTimeout(() => this.backNavSubject.next(false), 200);
        } else {
          // Normal navigation or first-time forward
          if (this.urlHistory[this.urlHistory.length - 1] !== currentUrl) {
            this.urlHistory.push(currentUrl);
          }
          this.backNavSubject.next(false);
        }
      });
  }

  public isBackNavigation(): boolean {
    return this.backNavSubject.getValue();
  }

  public getPreviousUrl(): string | null {
    return this.urlHistory.length > 1
      ? this.urlHistory[this.urlHistory.length - 2]
      : null;
  }

  public getCurrentUrl(): string | null {
    return this.urlHistory.length
      ? this.urlHistory[this.urlHistory.length - 1]
      : null;
  }
}
